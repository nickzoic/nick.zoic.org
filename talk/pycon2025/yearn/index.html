<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="flip.css">
  <script src="flip.js"></script>
  <title>The Children Yearn for the Mines</title>
</head>
<body>
  <div class="notes">
    Press "." to enter slideshow, once entered "PgUp" and "PgDn" to
    navigate, "Esc" to leave slideshow again.
  </div>
  <div class="slide">
    <h1>The Children Yearn for the Mines</h1>
    <h2>Importing Ultima IV maps into <s>Minecraft</s> <s>Minetest</s>Luanti</h2>
    <h3>Nick Moore</h3>
  </div>

  <div class="notes">
	  This is a presentation about copying the Ultima IV maps into
	  Minecraft, well not minecraft but a thing which was called Minetest
	  and is now called Luanti
  </div>

  <div class="slide">
	  <span style="font-size: 1200%">Procrastination</span>
  </div>

  <div class="notes">
	  it's okay I'll fix that later<br/>

	  actually it's a talk about procrastination.  Yesterday Ada gave a 
	  lightning talk about procrastination and I wanted to show that 
	  while students can procrastinate hard, senior devs can procrastinate
	  harder.
  </div>

  <div class="slide">
	  <h2>The Primordial Code</h2>
	  <h3>TODO:</h3>
	  <ul>
		  <li>history of cool stuff</li>
		  <li>4 billion years of biology in 10 minutes</li>
		  <li>even cooler stuff</li>
		  <li>you are in a twisty maze of wikipedia articles, all different</li>
		  <li>evolution wtaf are you don</li>
		  <li>is everything a fish?</li>
		  <li><b>XXX TODO finish todo list LOL</b></li>
	  </ul>
   </div>

   <div class="notes">
	   anyway I was working on yesterday's presentation about bioinformatics and
	   I'd gotten as far as a to-do list which had lots to do and it was a lot
	   of hard work but all I had to do was get on with it but ...
    </div>

  <div class="slide">
	  <img src="img/zstats0.png" width="60%">
  </div>

  <div class="notes">
	  anyway so when I was a teenager I really loved this game called Ultima IV
	  which ran on the apple 2 and even though there you saw the world through this
	  tiny window ...
  </div>

  <div class="slide">
	  <img src="img/world.png" width="50%">
  </div>

  <div class="notes">
	  ... there was a whole world there in your imagination.  Places in games can seem really really even though they're just imaginary ...
  </div>

  <div class="slide">
	  <h2>Minecraft</h2>
	  <em>Images of Minecraft are the intellectual property of Microsoft.<br/>
		  This is not a place of honor.<br/>
		  Do not fold, spindle or mutilate.
	  </em>
  </div>

  <div class="notes">
	  NO PICTURES.

	  Anyway, when Minecraft came out I thought about how cool it would be if I 
	  could take the blocky maps from Ultima IV and put them into the blocky world
	  of Minecraft.

	  Several years later ...
  </div>

   <div class="slide">
	   <h2>Reading the Map</h2>

	   <pre class="small">with open("dat/WORLD.MAP", "rb") as fh:
    ultima_world = fh.read(256*256)

def get_block(x, y):
    return ultima_world[(y//32)*8192+(x//32)*1024+(y%32)*32+(x%32)]</pre>
   </div>

   <div class="notes">
	   reading the Ultima IV map is really easy because computers were too
	   primitive to be difficult and so it's just a bunch of bytes in a file 
	   but not in order of course because computers
   </div>

   <div class="slide">
	   <h2>Writing the Map</h2>

	   <s>Minecraft</s><br/>
	   <s>Minetest</s><br/>
	   <b>Luanti</b>
   </div>

   <div class="notes">
	   Instead of targeting Minecraft which is closed source and in Java `:-(`
	   I decided to target Luanti which is open source and in Lua `:-/`
   </div>

   <div class="slide"> 
	   <pre class="small">def block_to_data(block):
    # block is a binary array of node IDs in ZYX order.
    assert len(block) == 4096

    # headers

    yield 14 # flags: generated, lighting expired, day_night_differs, NOT is_underground
    yield from u16(0) # lighting needs recomputing in all directions
    yield from u32(0xffffffff) # timestamp

    # block mapping: only bother including blocks present in
    # this sector.

    present_blocks = set(block)
    present_block_map = [ (k, v) for k, v in block_map.items() if v in present_blocks ]

    yield 0    # mapping version
    yield from u16(len(present_block_map)) # length of block map
    for k, v in present_block_map:
        yield from u16(v)
        yield from u16(len(k))
	yield from bytes(k, 'ascii')</pre>
   </div>

   <div class="notes">
	   the file format for this is documented.  It's very weird but at least
	   it is documented.  Well, more like "confessed".
	   <br/>
	   I promised I'd show some python source code at this python conference
	   so here it is.  There's no syntax highlighting.  Git gud.
	   <br/>
	   it builds a bunch of binary data ...
   </div>

   <div class="slide">
	<pre class="small">yield 2 # content_width (always 2)
    yield 2 # params_width  (always 2)

    for b in block:
        yield from u16(b) # param0

    for b in block:
        yield 0           # param1

    for b in block:
        yield 0           # param2

    yield from u32(0)

    yield 10             # timer record size (always 10)
    yield from u16(0)  # no timers</pre>
   </div>

   <div class="notes">
	   ... and some metadata which I don't really understand but I just
	   set it mostly to 0 and it sort of works.
   </div>

   <div class="slide">
	   <pre class="small">def block_to_binary(block):
    yield 29              # chunk version number
    yield from zstd.compress(bytes(block_to_data(block)))

db = sqlite3.connect('/home/nick/.minetest/worlds/x/map.sqlite')

def write_block(x, y, z, block):
    pos = z * 4096 * 4096 + y * 4096 + x
    data = bytes(block_to_binary(block))
    db.execute("insert or replace into blocks (pos, data) values (?, ?)", (pos, data))</pre>

   </div>

   <div class="notes">
	   Then it writes it into sqlite as a zlib compressed blob.
	   <br/>
	   Confession.
   </div>

   <div class="slide">
	   <img src="img/ss00.png" width="50%">
   </div>

   <div class="notes">
	   Now I could write 16x16x16 blocks of random crap into Luanti.
   </div>

   <div class="slide">
	   <img src="img/river.png" width="50%">
   </div>

   <div class="notes">
	   this is a bit of the Ultima IV map
   </div>


   <div class="slide">
	   <img src="img/ss2.png" width="50%">
   </div>

   <div class="notes">
	   here it is copied into Luanti, scaled up 1:12.
   </div>

   <div class="slide">
	   <img src="img/bandb.png" width="50%">
   </div>

   <div class="notes">
	   there's also towns and castles and stuff
   </div>

   <div class="slide">
	   <img src="img/britain.png" width="50%">
   </div>

   <div class="notes">
	   ... which have their own 32x32 maps so I just write them into
	   the map at the appropriate places, scaled 1:1.
   </div>

   <div class="slide">
	   <img src="img/ss14.png" width="70%">
   </div>

   <div class="notes">
	   that worked.
   </div>

   <div class="slide">
	   <img src="img/river2.png" width="60%">
   </div>

   <div class="notes">
	   it all looked a bit square and ugly though
   </div>

   <div class="slide">
	   <img src="img/median1.png" width="50%">
   </div>

   <div class="notes">
	   so I implemented a filter to round everything off
   </div>

   <div class="slide">
	   <img src="img/ss0913.png" width="50%">
   </div>
 
   <div class="notes">
	   and that looked a lot better
   </div>

   <div class="slide">
	   <h2>Ultima IV in Luanti</h2>
	   <ul>
		   <li>Mountains</li>
		   <li>Trees</li>
		   <li>Shrines</li>
		   <li>Dungeons</li>
		   <li>Moongates</li>
		   <li><b>XXX TODO finish TODO list ROFLcopter</b></li>
	   </ul>	
   </div>

   <div class="notes">
	   so now I had a whole list of other things to do: mountains needed
	   to grow up and oceans grow down and it needed trees and dungeons
	   and shrines and moongates and it was all a bit hard and tedious.
   </div>

  <div class="slide">
	  <span style="font-size: 1200%">Procrastination</span>
  </div>

  <div class="notes">
	  so i procrastinated
  </div>

  <div class="slide" style="background-image: url('img/yeast.jpg')">
	  <img src="img/qrcode.png">
	  <pre>https://nick.zoic.org/PYCON25/</pre>
  </div>

  <div class="notes">
	  and that's how I finished my bioinformatics presentation slides
  </div>

  <div class="footer">
    <span>Nick Moore &lt;nick@zoic.org&gt; for <a href=
    "https://2025.pycon.org.au/">PyCon AU 2025</a></span>
  </div>

</body>
</html>
